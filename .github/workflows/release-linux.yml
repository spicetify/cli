name: Release (Linux)

on:
   release:
      types: [published]

jobs:
   build:
      permissions:
         id-token: write
         contents: write
         attestations: write
      name: Build (Linux)
      strategy:
         matrix:
            arch: ["amd64", "arm64"]
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/v3')
      steps:
      -  name: Set Tag in env
         run: echo "tag=${GITHUB_REF#refs/*/v}" >> "$GITHUB_ENV"
      -  name: Checkout
         uses: actions/checkout@v4
      -  name: Setup Go
         uses: actions/setup-go@v5
         with:
            go-version-file: "go.mod"
      -  name: Build
         shell: bash
         run: |
            mkdir dist
            go build -o dist/spicetify-${{ env.tag }}-linux-${{ matrix.arch }} -ldflags "-X main.version=${{ env.tag }}"
         env:
            GOARCH: ${{ matrix.arch }}
      -  name: Attest output
         uses: actions/attest-build-provenance@v1
         with:
            subject-path: "./dist/spicetify-${{ env.tag }}-linux-${{ matrix.arch }}"
            subject-name: "spicetify v${{ env.tag }} (linux, ${{ matrix.arch }})"
      -  name: Upload artifact to release
         uses: softprops/action-gh-release@v2
         with:
            files: "dist/*"
         env:
            GITHUB_TOKEN: ${{ inputs.GH_TOKEN }}